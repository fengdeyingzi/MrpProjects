# 合成大金鱼 - 功能机C语言版本转换说明

## 转换完成情况

已成功将HTML5版本的合成大金鱼游戏转换为功能机C语言版本（240x320分辨率）。

## 主要实现功能

### 1. 游戏核心逻辑
- ✅ 鱼的类型定义（9种鱼类）
- ✅ 物理引擎（重力、碰撞、摩擦力）
- ✅ 碰撞检测和合成系统
- ✅ 游戏状态管理
- ✅ 分数系统
- ✅ 游戏结束检测

### 2. 数据结构
- **FishType**: 鱼类型定义（等级、半径、分值、图片名）
- **Fish**: 物理对象（位置、速度、状态）
- **GameState**: 游戏状态（分数、当前鱼、游戏状态）

### 3. 物理系统
- 重力系统：GRAVITY = 0.3f
- 弹性碰撞：RESTITUTION = 0.3f
- 摩擦力：FRICTION = 0.98f
- 边界碰撞检测（左右墙、地面）
- 圆形碰撞检测和分离

### 4. 游戏玩法
- 触摸屏幕投放鱼（从触摸位置的X坐标投放）
- 方向键控制投放位置（左右移动）
- 确认键投放鱼
- 相同等级的鱼碰撞后合成更高级的鱼
- 警戒线超限游戏结束

### 5. 平台适配
- ✅ 移除了系统头文件（string.h, stdlib.h, math.h）
- ✅ 使用mrc平台函数（mrc_memcpy等自动替换）
- ✅ 实现快速平方根函数（替代math.h的sqrt）
- ✅ 实现线性同余随机数生成器（替代stdlib.h的rand）
- ✅ 使用mrc_getUptime()初始化随机种子

## 资源文件需求

需要在 `assets/240/` 目录下准备以下PNG图片（会自动转换为bma格式）：

1. fish_01_240.png - 水滴（半径22px）
2. fish_02_240.png - 小蝌蚪（半径32px）
3. fish_03_240.png - 灯鱼（半径44px）
4. fish_04_240.png - 小丑鱼（半径60px）
5. fish_05_240.png - 神仙鱼（半径76px）
6. fish_06_240.png - 锦鲤（半径96px）
7. fish_07_240.png - 金龙鱼（半径118px）
8. fish_08_240.png - 发光水母（半径140px）
9. fish_09_240.png - 大金鱼（半径166px）

**注意**：每个图片的尺寸应为 `半径*2 x 半径*2` 的正方形。

## 控制方式

### 触摸屏操作
- **触摸松开**：从触摸位置的X坐标投放鱼

### 按键操作
- **左方向键**：向左移动投放位置（每次10像素）
- **右方向键**：向右移动投放位置（每次10像素）
- **确认键（中间键）**：投放鱼
- **左软键**：退出游戏

### 游戏结束后
- **触摸屏幕**或**确认键**：重新开始游戏

## 游戏规则

1. 只能生成前5种小鱼（水滴到神仙鱼）
2. 两条相同等级的鱼碰撞后合成下一级鱼
3. 合成得分为当前鱼分值的2倍
4. 鱼超过警戒线（Y=80）并静止超过3.3秒（100帧）判定游戏结束
5. 最高等级为大金鱼（等级8）

## 性能优化

- 最大同时存在50条鱼（MAX_FISH = 50）
- 30FPS游戏循环（定时器33ms）
- 每帧更新物理、碰撞检测、渲染
- 使用快速平方根算法提高性能

## 编译说明

1. 使用mrpbuilder进行编译
2. 确保assets/240目录下有对应的鱼图片
3. 图片会自动转换为bma格式
4. 编译目标：C98标准（不支持C99）

## 已知限制

1. 不支持半透明效果（功能机限制）
2. 投放预览无法完全半透明显示
3. 无法使用Matter.js物理引擎，使用简化的物理模拟

## 与HTML5版本的差异

| 特性 | HTML5版本 | 功能机版本 |
|------|-----------|-----------|
| 分辨率 | 450x750 | 240x320 |
| 物理引擎 | Matter.js | 自实现简化版 |
| 图形 | Emoji | PNG图片 |
| 鱼半径 | 原始尺寸 | 按比例缩放 |
| 背景气泡 | CSS动画 | 无（性能考虑） |
| 半透明效果 | 支持 | 不支持 |

## 后续优化建议

1. 添加最高分持久化存储
2. 添加音效支持
3. 优化碰撞检测算法（空间分区）
4. 添加合成特效
5. 优化图片加载（延迟加载）
