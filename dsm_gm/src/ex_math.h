#ifndef __EX_MATH_H__
#define __EX_MATH_H__

#include "mrc_base.h"

#ifndef M_PI
#define M_PI 3.14159265358979323846
#endif

// 三角函数查找表，使用4096倍缩放
// 角度范围：0-360度，每度一个值

#define TRIG_SCALE 4096
#define SIN_TABLE_SIZE 360

static const int32 sin_table[SIN_TABLE_SIZE] = {
           0,       71,      143,      214,      286,      357,      428,      499,      570,      641,
         711,      782,      852,      921,      991,     1060,     1129,     1198,     1266,     1334,
        1401,     1468,     1534,     1600,     1666,     1731,     1796,     1860,     1923,     1986,
        2048,     2110,     2171,     2231,     2290,     2349,     2408,     2465,     2522,     2578,
        2633,     2687,     2741,     2793,     2845,     2896,     2946,     2996,     3044,     3091,
        3138,     3183,     3228,     3271,     3314,     3355,     3396,     3435,     3474,     3511,
        3547,     3582,     3617,     3650,     3681,     3712,     3742,     3770,     3798,     3824,
        3849,     3873,     3896,     3917,     3937,     3956,     3974,     3991,     4006,     4021,
        4034,     4046,     4056,     4065,     4074,     4080,     4086,     4090,     4094,     4095,
        4096,     4095,     4094,     4090,     4086,     4080,     4074,     4065,     4056,     4046,
        4034,     4021,     4006,     3991,     3974,     3956,     3937,     3917,     3896,     3873,
        3849,     3824,     3798,     3770,     3742,     3712,     3681,     3650,     3617,     3582,
        3547,     3511,     3474,     3435,     3396,     3355,     3314,     3271,     3228,     3183,
        3138,     3091,     3044,     2996,     2946,     2896,     2845,     2793,     2741,     2687,
        2633,     2578,     2522,     2465,     2408,     2349,     2290,     2231,     2171,     2110,
        2048,     1986,     1923,     1860,     1796,     1731,     1666,     1600,     1534,     1468,
        1401,     1334,     1266,     1198,     1129,     1060,      991,      921,      852,      782,
         711,      641,      570,      499,      428,      357,      286,      214,      143,       71,
           0,      -71,     -143,     -214,     -286,     -357,     -428,     -499,     -570,     -641,
        -711,     -782,     -852,     -921,     -991,    -1060,    -1129,    -1198,    -1266,    -1334,
       -1401,    -1468,    -1534,    -1600,    -1666,    -1731,    -1796,    -1860,    -1923,    -1986,
       -2048,    -2110,    -2171,    -2231,    -2290,    -2349,    -2408,    -2465,    -2522,    -2578,
       -2633,    -2687,    -2741,    -2793,    -2845,    -2896,    -2946,    -2996,    -3044,    -3091,
       -3138,    -3183,    -3228,    -3271,    -3314,    -3355,    -3396,    -3435,    -3474,    -3511,
       -3547,    -3582,    -3617,    -3650,    -3681,    -3712,    -3742,    -3770,    -3798,    -3824,
       -3849,    -3873,    -3896,    -3917,    -3937,    -3956,    -3974,    -3991,    -4006,    -4021,
       -4034,    -4046,    -4056,    -4065,    -4074,    -4080,    -4086,    -4090,    -4094,    -4095,
       -4096,    -4095,    -4094,    -4090,    -4086,    -4080,    -4074,    -4065,    -4056,    -4046,
       -4034,    -4021,    -4006,    -3991,    -3974,    -3956,    -3937,    -3917,    -3896,    -3873,
       -3849,    -3824,    -3798,    -3770,    -3742,    -3712,    -3681,    -3650,    -3617,    -3582,
       -3547,    -3511,    -3474,    -3435,    -3396,    -3355,    -3314,    -3271,    -3228,    -3183,
       -3138,    -3091,    -3044,    -2996,    -2946,    -2896,    -2845,    -2793,    -2741,    -2687,
       -2633,    -2578,    -2522,    -2465,    -2408,    -2349,    -2290,    -2231,    -2171,    -2110,
       -2048,    -1986,    -1923,    -1860,    -1796,    -1731,    -1666,    -1600,    -1534,    -1468,
       -1401,    -1334,    -1266,    -1198,    -1129,    -1060,     -991,     -921,     -852,     -782,
        -711,     -641,     -570,     -499,     -428,     -357,     -286,     -214,     -143,      -71
};

// Cosine macros (cos = sin(angle + 90°))
#define COS(angle) sin_table[((angle) + 90) % SIN_TABLE_SIZE]
// Sine macro
#define SIN(angle) sin_table[(angle) % SIN_TABLE_SIZE]

// Usage example:
// int32_t angle = 45; // in degrees
// int32_t sin_val = SIN(angle); // scaled by 4096
// int32_t cos_val = COS(angle); // scaled by 4096
// To get actual value: float sin_actual = (float)sin_val / 4096.0f;
// To use in calculations: result = (a * SIN(angle)) / TRIG_SCALE;

// 角度转弧度（使用整数近似，256倍缩放）
#define DEG_TO_RAD_SCALED(angle) ((angle) * 7144 / 4096) // 7144 = 180 * 256 / π

// 整数三角函数宏
#define INT_SIN(angle) SIN(angle)
#define INT_COS(angle) COS(angle)

/**
 * 整数平方根函数（使用牛顿迭代法）
 * 输入: n - 非负整数
 * 返回: floor(sqrt(n))
 */
static inline int32 int_sqrt(int32 n) {
    int32 x, x1;

    if (n <= 0) return 0;
    if (n == 1) return 1;

    /* 初始估计值：使用位移找到最接近的2的幂 */
    x = n;
    x1 = (x + 1) >> 1;

    /* 牛顿迭代：x(n+1) = (x(n) + n/x(n)) / 2 */
    while (x1 < x) {
        x = x1;
        x1 = (x + n / x) >> 1;
    }

    return x;
}

#define ex_abs(x) ((x) < 0 ? -(x) : (x))
#define ex_max(a, b) ((a) > (b) ? (a) : (b))
#define ex_min(a, b) ((a) < (b) ? (a) : (b))
#ifndef MAX
    #define  MAX( x, y ) ( ((x) > (y)) ? (x) : (y) )
#endif
#ifndef MIN
    #define  MIN( x, y ) ( ((x) < (y)) ? (x) : (y) )
#endif
#ifndef ABS
    #define ABS(VAL) (((VAL)>0)?(VAL):(-(VAL)))
#endif

#endif // __EX_MATH_H__
